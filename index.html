<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Armaan's Odyssey</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    /* ‚îÄ‚îÄ Fifth Avenue Vintage Palette ‚îÄ‚îÄ */
    :root {
      --cream:   #f2ede3;
      --cream2:  #e6ddd0;
      --sky:     #8ab4c4;
      --tan:     #c8a86e;
      --sage:    #85a05c;
      --red:     #cc4535;
      --ink:     #3a3028;
      --ink-mid: #7a6855;
      --shadow:  rgba(58, 48, 40, 0.18);
    }

    body {
      background-color: var(--cream);
      background-image:
        repeating-linear-gradient(0deg,  rgba(138,180,196,0.09) 0px, rgba(138,180,196,0.09) 1px, transparent 1px, transparent 70px),
        repeating-linear-gradient(90deg, rgba(138,180,196,0.09) 0px, rgba(138,180,196,0.09) 1px, transparent 1px, transparent 70px);
      font-family: 'EB Garamond', serif;
      color: var(--ink);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ */
    header {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 52px 24px 36px;
      background: linear-gradient(180deg, var(--cream2) 0%, var(--cream) 100%);
      border-bottom: 3px solid var(--red);
    }

    .header-ornament {
      font-size: 1rem;
      color: var(--tan);
      letter-spacing: 10px;
      display: block;
      margin-bottom: 14px;
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(2.6rem, 6vw, 4.4rem);
      font-style: italic;
      font-weight: 600;
      color: var(--ink);
      letter-spacing: 2px;
      line-height: 1.1;
    }

    .subtitle {
      margin-top: 12px;
      font-size: 0.82rem;
      letter-spacing: 6px;
      text-transform: uppercase;
      color: var(--sky);
    }

    .divider {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      margin: 18px auto 0;
      max-width: 340px;
      color: var(--red);
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--red);
      opacity: 0.5;
    }

    .city-count {
      margin-top: 18px;
      font-style: italic;
      font-size: 1.05rem;
      color: var(--ink-mid);
    }

    /* ‚îÄ‚îÄ‚îÄ Compass rose ‚îÄ‚îÄ‚îÄ */
    .compass-rose {
      margin: 20px auto 0;
      width: 52px;
      height: 52px;
      opacity: 0.55;
    }

    /* ‚îÄ‚îÄ‚îÄ Map wrapper ‚Äî no border, blends into background ‚îÄ‚îÄ‚îÄ */
    .map-wrap {
      position: relative;
      z-index: 1;
      width: calc(100% - 60px);
      max-width: 1200px;
      margin: 32px auto 28px;
    }

    .map-frame {
      border: 3px solid var(--cream);   /* invisible ‚Äî same as bg */
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 8px 32px var(--shadow);
    }

    #map {
      height: 68vh;
      min-height: 480px;
    }

    /* ‚îÄ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ */
    footer {
      position: relative;
      z-index: 1;
      text-align: center;
      padding: 28px 16px 44px;
      font-style: italic;
      font-size: 0.95rem;
      color: var(--ink-mid);
      border-top: 3px solid var(--red);
      background: linear-gradient(0deg, var(--cream2) 0%, var(--cream) 100%);
    }

    footer .footer-ornament {
      display: block;
      font-size: 1rem;
      letter-spacing: 8px;
      color: var(--tan);
      margin-bottom: 8px;
    }

    /* ‚îÄ‚îÄ‚îÄ Leaflet popup ‚îÄ‚îÄ‚îÄ */
    .leaflet-popup-content-wrapper {
      background: var(--cream);
      border: 2px solid var(--tan);
      border-radius: 4px;
      box-shadow: 0 6px 28px var(--shadow);
      padding: 0;
    }

    .leaflet-popup-content {
      margin: 0;
      width: 280px !important;
    }

    .leaflet-popup-tip-container { margin-top: -1px; }
    .leaflet-popup-tip { background: var(--tan); }

    .leaflet-popup-close-button {
      color: var(--ink-mid) !important;
      font-size: 18px !important;
      padding: 6px 8px !important;
    }

    /* ‚îÄ‚îÄ‚îÄ Popup card ‚îÄ‚îÄ‚îÄ */
    .popup-card {
      text-align: center;
      font-family: 'EB Garamond', serif;
      color: var(--ink);
      overflow: hidden;
      border-radius: 3px;
    }

    .popup-img-wrap {
      width: 100%;
      height: 210px;
      overflow: hidden;
      position: relative;
      background: var(--cream2);
    }

    .popup-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      display: block;
      transition: transform 0.4s ease;
    }

    .popup-img-wrap img:hover { transform: scale(1.04); }

    .popup-img-wrap .img-loader {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-style: italic;
      font-size: 0.85rem;
      color: var(--ink-mid);
    }

    .popup-body {
      padding: 14px 16px 16px;
      border-top: 2px solid var(--tan);
    }

    .popup-body h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.35rem;
      font-style: italic;
      color: var(--ink);
      margin-bottom: 2px;
    }

    .popup-body .popup-country {
      font-size: 0.78rem;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--sky);
      margin-bottom: 8px;
    }

    .popup-body .popup-attraction {
      font-size: 0.88rem;
      font-style: italic;
      color: var(--red);
    }

    /* ‚îÄ‚îÄ‚îÄ Song name label ‚îÄ‚îÄ‚îÄ */
    .popup-song {
      padding: 10px 16px 14px;
      border-top: 1px solid rgba(200,168,110,0.3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-family: 'EB Garamond', serif;
      font-style: italic;
      font-size: 0.95rem;
      color: var(--ink-mid);
      letter-spacing: 0.5px;
    }

    .popup-play-btn {
      flex-shrink: 0;
      background: var(--red);
      border: none;
      color: #fff;
      border-radius: 50%;
      width: 26px;
      height: 26px;
      cursor: pointer;
      font-size: 0.68rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding-left: 2px;
      transition: background 0.18s;
    }
    .popup-play-btn:hover { background: var(--ink); }

    /* hidden audio element ‚Äî no visible player */
    .popup-audio { display: none; }

    /* ‚îÄ‚îÄ‚îÄ City lists ‚îÄ‚îÄ‚îÄ */
    .city-lists {
      width: calc(100% - 60px);
      max-width: 1200px;
      margin: 0 auto 40px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .list-panel {
      background: var(--cream2);
      border-radius: 4px;
      border: 1px solid rgba(200,168,110,0.5);
      overflow: hidden;
      box-shadow: 0 4px 18px var(--shadow);
    }

    .list-panel-header {
      padding: 15px 22px;
      background: linear-gradient(135deg, #ddd4c2, var(--cream2));
      border-bottom: 2px solid var(--tan);
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      font-style: italic;
      color: var(--ink);
      letter-spacing: 0.5px;
    }

    .list-panel ul {
      list-style: none;
      padding: 6px 0;
    }

    .list-panel li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 9px 22px;
      border-bottom: 1px solid rgba(200,168,110,0.18);
    }

    .list-panel li:last-child { border-bottom: none; }

    .city-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-family: 'EB Garamond', serif;
      font-size: 1.08rem;
      color: var(--ink);
      padding: 0;
      text-align: left;
      transition: color 0.18s;
      text-decoration: underline;
      text-decoration-color: transparent;
      text-underline-offset: 3px;
      transition: color 0.18s, text-decoration-color 0.18s;
    }

    .city-btn:hover {
      color: var(--red);
      text-decoration-color: var(--red);
    }

    .list-country {
      font-size: 0.75rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--sky);
    }

    .coming-city-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-family: 'EB Garamond', serif;
      font-size: 1.08rem;
      color: var(--ink-mid);
      font-style: italic;
      padding: 0;
      text-align: left;
      text-decoration: underline;
      text-decoration-color: transparent;
      text-underline-offset: 3px;
      transition: color 0.18s, text-decoration-color 0.18s;
    }

    .coming-city-btn:hover {
      color: var(--sky);
      text-decoration-color: var(--sky);
    }

    /* ‚îÄ‚îÄ‚îÄ Photo coming soon placeholder ‚îÄ‚îÄ‚îÄ */
    .photo-soon {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--cream2);
      gap: 10px;
    }

    .photo-soon .soon-icon {
      font-size: 2rem;
      opacity: 0.45;
    }

    .photo-soon p {
      font-family: 'EB Garamond', serif;
      font-style: italic;
      font-size: 0.95rem;
      color: var(--ink-mid);
      letter-spacing: 1px;
    }

    @media (max-width: 620px) {
      .city-lists { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <span class="header-ornament">‚ú¶ ‚ú¶ ‚ú¶</span>
    <h1>Armaan's Odyssey</h1>
    <p class="subtitle">A Journey Through Europe</p>
    <div class="divider">‚ú¶</div>
    <p class="city-count">Many more cities and countries to come!!</p>
    <svg class="compass-rose" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <g fill="none" stroke="#c8a86e" stroke-width="1.2">
        <circle cx="50" cy="50" r="38"/>
        <circle cx="50" cy="50" r="28"/>
        <circle cx="50" cy="50" r="4" fill="#c8a86e"/>
        <line x1="50" y1="12" x2="50" y2="88"/>
        <line x1="12" y1="50" x2="88" y2="50"/>
        <line x1="23" y1="23" x2="77" y2="77" stroke-width="0.7" opacity="0.5"/>
        <line x1="77" y1="23" x2="23" y2="77" stroke-width="0.7" opacity="0.5"/>
        <polygon points="50,12 46,28 50,24 54,28" fill="#cc4535"/>
        <polygon points="50,88 46,72 50,76 54,72" fill="#c8a86e" opacity="0.7"/>
        <polygon points="88,50 72,46 76,50 72,54" fill="#c8a86e" opacity="0.7"/>
        <polygon points="12,50 28,46 24,50 28,54" fill="#c8a86e" opacity="0.7"/>
      </g>
      <text x="50" y="9"  text-anchor="middle" fill="#cc4535" font-size="7" font-family="serif" font-weight="bold">N</text>
      <text x="50" y="97" text-anchor="middle" fill="#c8a86e" font-size="7" font-family="serif">S</text>
      <text x="96" y="53" text-anchor="middle" fill="#c8a86e" font-size="7" font-family="serif">E</text>
      <text x="4"  y="53" text-anchor="middle" fill="#c8a86e" font-size="7" font-family="serif">W</text>
    </svg>
  </header>

  <div class="map-wrap">
    <div class="map-frame">
      <div id="map"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ City Lists ‚îÄ‚îÄ -->
  <div class="city-lists">

    <div class="list-panel">
      <div class="list-panel-header">Visited ‚úÖ</div>
      <ul>
        <li><button class="city-btn" onclick="flyToCity('Madrid')">Madrid</button>          <span class="list-country">Spain</span></li>
        <li><button class="city-btn" onclick="flyToCity('Valencia')">Valencia</button>        <span class="list-country">Spain</span></li>
        <li><button class="city-btn" onclick="flyToCity('Budapest')">Budapest</button>        <span class="list-country">Hungary</span></li>
        <li><button class="city-btn" onclick="flyToCity('Milan')">Milan</button>              <span class="list-country">Italy</span></li>
        <li><button class="city-btn" onclick="flyToCity('Lake Como')">Lake Como</button>      <span class="list-country">Italy</span></li>
        <li><button class="city-btn" onclick="flyToCity('Chiasso')">Chiasso</button>          <span class="list-country">Switzerland</span></li>
        <li><button class="city-btn" onclick="flyToCity('Zurich')">Zurich</button>            <span class="list-country">Switzerland</span></li>
        <li><button class="city-btn" onclick="flyToCity('Vienna')">Vienna</button>            <span class="list-country">Austria</span></li>
      </ul>
    </div>

    <div class="list-panel">
      <div class="list-panel-header">Coming Soon ‚úàÔ∏è</div>
      <ul>
        <li><button class="coming-city-btn" onclick="flyToCity('Florence')">Florence</button>      <span class="list-country">Italy</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Dublin')">Dublin</button>          <span class="list-country">Ireland</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Copenhagen')">Copenhagen</button>  <span class="list-country">Denmark</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('London')">London</button>          <span class="list-country">England</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Paris')">Paris</button>            <span class="list-country">France</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Venice')">Venice</button>          <span class="list-country">Italy</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Dubrovnik')">Dubrovnik</button>    <span class="list-country">Croatia</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Split')">Split</button>            <span class="list-country">Croatia</span></li>
        <li><button class="coming-city-btn" onclick="flyToCity('Amsterdam')">Amsterdam</button>    <span class="list-country">Netherlands</span></li>
      </ul>
    </div>

  </div>

  <footer>
    <span class="footer-ornament">‚ú¶</span>
    Thank you Mom and Dad
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', {
      center: [47.2, 10.5],
      zoom: 5,
      zoomControl: true,
      scrollWheelZoom: true
    });

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Tiles &copy; Esri',
      maxZoom: 19
    }).addTo(map);

    /* ‚îÄ‚îÄ Marker references (visited + coming soon) ‚îÄ‚îÄ */
    const allMarkers = {};

    /* ‚îÄ‚îÄ Coming soon city data ‚îÄ‚îÄ */
    const comingSoon = [
      { name: 'Florence',   country: 'Italy',    lat: 43.7696, lng: 11.2558 },
      { name: 'Dublin',     country: 'Ireland',  lat: 53.3498, lng: -6.2603 },
      { name: 'Copenhagen', country: 'Denmark',  lat: 55.6761, lng: 12.5683 },
      { name: 'London',     country: 'England',  lat: 51.5074, lng: -0.1278 },
      { name: 'Paris',      country: 'France',   lat: 48.8566, lng:  2.3522 },
      { name: 'Venice',     country: 'Italy',    lat: 45.4408, lng: 12.3155 },
      { name: 'Dubrovnik',  country: 'Croatia',  lat: 42.6507, lng: 18.0944 },
      { name: 'Split',      country: 'Croatia',  lat: 43.5081, lng: 16.4402 },
      { name: 'Amsterdam',  country: 'Netherlands', lat: 52.3676, lng:  4.9041 }
    ];

    /* ‚îÄ‚îÄ Grey ball-and-stick pin for coming soon ‚îÄ‚îÄ */
    function makeGrayPin() {
      return L.divIcon({
        html: `
          <div style="display:flex;flex-direction:column;align-items:center;width:22px;cursor:pointer;opacity:0.72;">
            <div style="
              width:18px;height:18px;
              background: radial-gradient(circle at 37% 33%, rgba(255,255,255,0.4), #7a7a7a 60%);
              border-radius:50%;
              box-shadow:1px 2px 5px rgba(0,0,0,0.35),inset -1px -1px 3px rgba(0,0,0,0.15);
              flex-shrink:0;
            "></div>
            <div style="
              width:2.5px;height:13px;
              background:linear-gradient(to bottom,#7a7a7a 0%,rgba(40,40,40,0.6) 100%);
              border-radius:0 0 2px 2px;
            "></div>
          </div>`,
        className: '',
        iconSize:   [22, 31],
        iconAnchor: [11, 31],
        popupAnchor:[0, -33]
      });
    }

    /* ‚îÄ‚îÄ Popup for coming soon cities ‚îÄ‚îÄ */
    function comingSoonPopupHTML(city) {
      return `
        <div class="popup-card">
          <div class="popup-img-wrap">
            <div class="photo-soon">
              <span class="soon-icon">üì∑</span>
              <p>Photo Coming Soon</p>
            </div>
          </div>
          <div class="popup-body">
            <h2>${city.name}</h2>
            <p class="popup-country">${city.country}</p>
            <p class="popup-attraction" style="color:var(--sky);font-style:italic;">Coming soon...</p>
          </div>
        </div>`;
    }

    /* ‚îÄ‚îÄ Add coming soon markers ‚îÄ‚îÄ */
    comingSoon.forEach(city => {
      const marker = L.marker([city.lat, city.lng], { icon: makeGrayPin() }).addTo(map);
      marker.bindPopup(comingSoonPopupHTML(city), { maxWidth: 280 });
      allMarkers[city.name] = marker;
    });

    /* ‚îÄ‚îÄ Unified fly-to (works for both lists) ‚îÄ‚îÄ */
    function flyToCity(cityName) {
      const city   = [...cities, ...comingSoon].find(c => c.name === cityName);
      const marker = allMarkers[cityName];
      if (!city || !marker) return;
      map.flyTo([city.lat, city.lng], 10, { duration: 1.2 });
      setTimeout(() => marker.openPopup(), 1300);
    }

    /* ‚îÄ‚îÄ Vintage pin colors cycling through the palette ‚îÄ‚îÄ */
    const pinColors = ['#cc4535', '#85a05c', '#c8a86e', '#8ab4c4', '#7a6040'];

    /* ‚îÄ‚îÄ Ball-and-stick map pin ‚îÄ‚îÄ */
    function makePin(color) {
      const light = 'rgba(255,255,255,0.45)';
      return L.divIcon({
        html: `
          <div style="display:flex;flex-direction:column;align-items:center;width:22px;cursor:pointer;">
            <div style="
              width:18px;height:18px;
              background: radial-gradient(circle at 37% 33%, ${light}, ${color} 60%);
              border-radius:50%;
              box-shadow:1px 2px 5px rgba(0,0,0,0.45),inset -1px -1px 3px rgba(0,0,0,0.2);
              flex-shrink:0;
            "></div>
            <div style="
              width:2.5px;height:13px;
              background:linear-gradient(to bottom,${color} 0%,rgba(40,28,18,0.7) 100%);
              border-radius:0 0 2px 2px;
            "></div>
          </div>`,
        className: '',
        iconSize:   [22, 31],
        iconAnchor: [11, 31],
        popupAnchor:[0, -33]
      });
    }

    /* ‚îÄ‚îÄ City data ‚Äî Valencia has a direct beach image ‚îÄ‚îÄ */
    const cities = [
      {
        name: 'Madrid', country: 'Spain',
        lat: 40.4168, lng: -3.7038,
        attraction: 'Royal Palace of Madrid',
        img: 'img/madrid.jpg',
        audio: { src: 'audio/madrid.mp3', start: 5, title: 'Candela ‚Äî Buena Vista Social Club' }
      },
      {
        name: 'Valencia', country: 'Spain',
        lat: 39.4699, lng: -0.3763,
        attraction: 'La Malvarrosa Beach',
        img: 'img/valencia.jpg',
        audio: { src: 'audio/valencia.mp3', start: 0, title: 'Reflection ‚Äî Riordan' }
      },
      {
        name: 'Budapest', country: 'Hungary',
        lat: 47.4979, lng: 19.0402,
        attraction: 'Hungarian Parliament Building',
        img: 'img/budapest.jpg',
        audio: { src: 'audio/budapest.mp3', start: 0, title: "Don't Bring Me Down" }
      },
      {
        name: 'Milan', country: 'Italy',
        lat: 45.4642, lng: 9.1900,
        attraction: 'Milan Cathedral (Duomo)',
        img: 'img/milan.jpg',
        audio: { src: 'audio/milan.mp3', start: 16, end: 37, title: 'Sar√† Perch√© Ti Amo' }
      },
      {
        name: 'Lake Como', country: 'Italy',
        lat: 45.9940, lng: 9.2577,
        attraction: 'Lake Como',
        img: 'img/lakecomo.jpg',
        audio: { src: 'audio/milan.mp3', start: 0, title: 'Sar√† Perch√© Ti Amo ‚Äî Ricchi e Poveri' }
      },
      {
        name: 'Chiasso', country: 'Switzerland',
        lat: 45.8418, lng: 9.0328,
        attraction: 'Chiasso',
        img: 'img/chiasso.jpg',
        audio: { src: 'audio/chiasso.mp3', start: 0, title: "Knockin' On Heaven's Door ‚Äî Bob Dylan" }
      },
      {
        name: 'Zurich', country: 'Switzerland',
        lat: 47.3769, lng: 8.5417,
        attraction: 'City & Lake Z√ºrich',
        img: 'img/zurich.jpg',
        audio: { src: 'audio/zurich.mp3', start: 0, title: 'Get It Together' }
      },
      {
        name: 'Vienna', country: 'Austria',
        lat: 48.2082, lng: 16.3738,
        attraction: 'Infinity of Light at Votivkirche',
        img: 'img/vienna.jpg',
        audio: { src: 'audio/vienna.mp3', start: 80, title: 'WANT NEED LOVE ‚Äî Prospa' }
      }
    ];

    function popupHTML(city, imgSrc) {
      const songLabel = city.audio ? `
        <div class="popup-song">
          <span>‚ô™ &nbsp;${city.audio.title}</span>
          <button class="popup-play-btn" aria-label="Play">‚ñ∂</button>
        </div>
        <audio class="popup-audio" preload="none"
               data-start="${city.audio.start}"${city.audio.end ? ` data-end="${city.audio.end}"` : ''}>
          <source src="${city.audio.src}" type="audio/mpeg" />
        </audio>` : '';
      return `
        <div class="popup-card">
          <div class="popup-img-wrap">
            <img src="${imgSrc}" alt="${city.attraction}" loading="lazy"
                 onerror="this.parentElement.innerHTML='<div class=\'img-loader\'>No photo available</div>'" />
          </div>
          <div class="popup-body">
            <h2>${city.name}</h2>
            <p class="popup-country">${city.country}</p>
            <p class="popup-attraction">${city.attraction}</p>
          </div>
          ${songLabel}
        </div>`;
    }

    /* ‚îÄ‚îÄ Autoplay on popup open, stop on close ‚îÄ‚îÄ */
    map.on('popupopen', function(e) {
      const el    = e.popup.getElement();
      const audio = el?.querySelector('.popup-audio');
      if (!audio) return;

      const btn   = el.querySelector('.popup-play-btn');
      const start = parseFloat(audio.dataset.start) || 0;
      const end   = audio.dataset.end ? parseFloat(audio.dataset.end) : null;

      function onTimeUpdate() {
        if (end && audio.currentTime >= end) {
          audio.pause();
          audio.currentTime = start;
          if (btn) btn.textContent = '‚ñ∂';
        }
      }

      function startPlayback() {
        audio.currentTime = start;
        audio.ontimeupdate = onTimeUpdate;
        audio.play().then(() => {
          if (btn) btn.textContent = '‚è∏';
        }).catch(() => {
          /* Reset to clean state so first button tap works on mobile */
          audio.load();
          audio.currentTime = start;
          if (btn) btn.textContent = '‚ñ∂';
        });
      }

      if (btn) {
        btn.onclick = function() {
          if (audio.paused) {
            startPlayback();
          } else {
            audio.pause();
            btn.textContent = '‚ñ∂';
          }
        };
      }

      startPlayback();   /* autoplay on desktop; silently fails on mobile */
    });

    map.on('popupclose', function(e) {
      const audio = e.popup.getElement()?.querySelector('.popup-audio');
      if (!audio) return;
      audio.pause();
      audio.ontimeupdate = null;
    });

    function fetchAndBind(city, color) {
      const marker = L.marker([city.lat, city.lng], { icon: makePin(color) }).addTo(map);
      allMarkers[city.name] = marker;

      /* If a direct image is provided, skip the API call */
      if (city.img) {
        marker.bindPopup(popupHTML(city, city.img), { maxWidth: 280 });
        return;
      }

      const fallback = 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/No_image_available.svg/480px-No_image_available.svg.png';
      const apiUrl = `https://en.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(city.wiki)}&prop=pageimages&format=json&pithumbsize=640&origin=*`;

      fetch(apiUrl)
        .then(r => r.json())
        .then(data => {
          const pages = data.query.pages;
          const page  = pages[Object.keys(pages)[0]];
          const img   = (page && page.thumbnail) ? page.thumbnail.source : fallback;
          marker.bindPopup(popupHTML(city, img), { maxWidth: 280 });
        })
        .catch(() => marker.bindPopup(popupHTML(city, fallback), { maxWidth: 280 }));
    }

    cities.forEach((city, i) => fetchAndBind(city, pinColors[i % pinColors.length]));
  </script>
</body>
</html>
